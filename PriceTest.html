<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rental Calculator Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    label { display: grid; grid-template-columns: 160px minmax(0, 180px); gap: 12px; align-items: center; margin: 0; }
    input, select { padding: 0.3em; width: 100%; box-sizing: border-box; }
    button { margin-top: 1em; padding: 0.5em 1em; }
    .result { margin-top: 2em; padding: 1em; border: 1px solid #ccc; }
    .result h3 { margin-top: 0; }
    .form-section, .chart-controls { display: grid; gap: 12px; max-width: 520px; }
    .chart-controls h3 { margin: 0; }
    .tabs { margin-bottom: 1em; }
    .tablink { background: #eee; border: 1px solid #ccc; padding: 0.5em 1em; cursor: pointer; margin-right: 4px; }
    .tablink.active { background: #fff; border-bottom: 2px solid #0078d7; }
    .tabcontent { display: none; }
    .tabcontent.active { display: block; }
  </style>
</head>
<body>
  <h1>Rental Calculator</h1>
  <div class="tabs">
    <button class="tablink" onclick="openTab(event, 'inputTab')" id="defaultTab">Input</button>
    <button class="tablink" onclick="openTab(event, 'quantityTab')">Quantity Chart</button>
    <button class="tablink" onclick="openTab(event, 'daysTab')">Days Chart</button>
    <button class="tablink" onclick="openTab(event, 'tableTab')">Table</button>
  </div>

  <div id="inputTab" class="tabcontent">
    <div class="form-section">
      <label>
        Quantity:
        <input type="number" id="quantity" value="150">
      </label>
      <label>
        Base Rate:
        <input type="number" id="baseRate" value="4.98" step="0.01">
      </label>
      <label>
        Purchase Price:
        <input type="number" id="purchasePrice" value="100.00" step="0.01">
      </label>
      <label>
        Days:
        <input type="number" id="days" value="60">
      </label>
      <label>
        SKU:
        <input type="text" id="sku" value="default">
      </label>
    </div>
    <button onclick="runCalc()">Calculate</button>
    <div class="result" id="output"></div>
  </div>

  <div id="quantityTab" class="tabcontent" style="display:none">
    <h2>Quantity Chart</h2>
    <div class="chart-controls">
      <h3>Total vs Quantity</h3>
      <label>
        Plot:
        <select id="qtyChartMetric">
          <option value="discountedPrice">Discounted Price</option>
          <option value="totalDiscount">Total Discount</option>
          <option value="discountPct">Percent Discount</option>
          <option value="percentOfPurchase">% of Purchase Price</option>
        </select>
      </label>
      <label>
        Step:
        <input type="number" id="qtyChartStep" value="1">
      </label>
    </div>
    <canvas id="quantityChart" width="600" height="300"></canvas>
  </div>

  <div id="daysTab" class="tabcontent" style="display:none">
    <h2>Days Chart</h2>
    <div class="chart-controls">
      <h3>Total vs Days</h3>
      <label>
        Plot:
        <select id="dayChartMetric">
          <option value="discountedPrice">Discounted Price</option>
          <option value="totalDiscount">Total Discount</option>
          <option value="discountPct">Percent Discount</option>
          <option value="percentOfPurchase">% of Purchase Price</option>
        </select>
      </label>
      <label>
        Step:
        <input type="number" id="dayChartStep" value="1">
      </label>
    </div>
    <canvas id="dayChart" width="600" height="300"></canvas>
  </div>

  <div id="tableTab" class="tabcontent" style="display:none">
    <h2>Table</h2>
    <div class="chart-controls">
      <label>
        Plot:
        <select id="tableMetric">
          <option value="discountedPrice">Discounted Price</option>
          <option value="totalDiscount">Total Discount</option>
          <option value="discountPct">Percent Discount</option>
          <option value="percentOfPurchase">% of Purchase Price</option>
        </select>
      </label>
      <label>
        Qty Step:
        <input type="number" id="tableQtyStep" value="10">
      </label>
      <label>
        Days Step:
        <input type="number" id="tableDayStep" value="1">
      </label>
    </div>
    <div id="tableOutput"></div>
  </div>

<!-- Pricing data embedded as JSON -->
<script type="application/json" id="pricingDataJson">
{
  "pricingRules": {
    "default": {
      "calculateHandlingFee": true,
      "quantityTiers": [
        { "from": 1, "discount": 0.00 },
        { "from": 101, "discount": 0.10 },
        { "from": 201, "discount": 0.20 },
        { "from": 301, "discount": 0.30 },
        { "from": 401, "discount": 0.40 },
        { "from": 501, "discount": 0.50 },
        { "from": 601, "discount": 0.60 },
        { "from": 701, "discount": 0.70 },
        { "from": 801, "discount": 0.80 },
        { "from": 901, "discount": 0.90 }
      ],
      "dayDiscounts": [
        { "day": 1, "discount": 0.00 },
        { "day": 2, "discount": 0.15 },
        { "day": 3, "discount": 0.25 },
        { "day": 4, "discount": 0.35 },
        { "day": 5, "discount": 0.45 },
        { "day": 6, "discount": 0.55 },
        { "day": 7, "discount": 0.575 },
        { "day": 8, "discount": 0.65 },
        { "day": 9, "discount": 0.725 },
        { "day": 10, "discount": 0.755 },
        { "day": 11, "discount": 0.785 },
        { "day": 15, "discount": 0.815 },
        { "day": 20, "discount": 0.845 },
        { "day": 30, "discount": 0.875 },
        { "day": 60, "discount": 0.905 },
        { "day": 90, "discount": 0.935 }
      ],
      "handlingFees": [
        { "from": 1, "fee": 99 },
        { "from": 11, "fee": 149 },
        { "from": 31, "fee": 249 },
        { "from": 101, "fee": 399 },
        { "from": 301, "fee": 599 },
        { "from": 501, "fee": 799 }
      ]
    },
    "sku_headphones": {
      "baseRate": 500.00,
      "calculateHandlingFee": false,
      "quantityTiers": [
        { "from": 1, "discount": 0.00 },
        { "from": 50, "discount": 0.05 },
        { "from": 100, "discount": 0.10 }
      ],
      "dayDiscounts": [
        { "day": 1, "discount": 0.00 },
        { "day": 7, "discount": 0.20 },
        { "day": 14, "discount": 0.30 }
      ],
      "handlingFees": []
    }
  }
}

</script>

<script>
// Parse embedded JSON data
const pricingData = JSON.parse(document.getElementById('pricingDataJson').textContent);
</script>

<!-- Chart.js library (local) -->
<script src="./chart.umd.min.js"></script>

<!-- Pricing engine (core business logic) -->
<script src="./pricing.js"></script>

<!-- Chart renderer for testing UI -->
<script src="./chart-renderer.js"></script>

<!-- Initialize chart renderer and test UI -->
<script>
let chartRenderer;

// Tab logic
function openTab(evt, tabId) {
  const tabcontents = document.querySelectorAll('.tabcontent');
  tabcontents.forEach(tc => tc.style.display = 'none');
  tabcontents.forEach(tc => tc.classList.remove('active'));
  document.getElementById(tabId).style.display = 'block';
  document.getElementById(tabId).classList.add('active');
  const tablinks = document.querySelectorAll('.tablink');
  tablinks.forEach(tl => tl.classList.remove('active'));
  evt.currentTarget.classList.add('active');
}

document.addEventListener('DOMContentLoaded', () => {
  chartRenderer = new ChartRenderer(pricingData);
  document.getElementById('defaultTab').click();
  attachChartInputListeners();
});

// Test UI: Calculate button handler
function runCalc() {
  const qty = parseInt(document.getElementById("quantity").value, 10);
  const baseRate = parseFloat(document.getElementById("baseRate").value);
  const days = parseInt(document.getElementById("days").value, 10);
  const sku = document.getElementById("sku").value.trim();

  const engine = new PricingEngine(pricingData);
  const result = engine.calculateRental(qty, days, sku, baseRate);

  const purchasePriceInput = document.getElementById("purchasePrice");
  const purchasePrice = parseFloat(purchasePriceInput.value);
  const purchasePriceTotal = purchasePrice * qty;
  const rentalPercentOfPurchase = (result.discountedPrice / purchasePriceTotal) * 100;

  document.getElementById("output").innerHTML = `
    <h3>Results for SKU: ${result.sku}</h3>
    <p>Effective Quantity: ${result.effectiveQty.toFixed(2)}</p>
    <p>Discounted Daily rate: $${result.discountedDailyRate.toFixed(2)}</p>
    <p>Discounted Price: $${result.discountedPrice.toFixed(2)}</p>
    <p>Handling Fee: $${result.handlingFee.toFixed(2)}</p>
    <p><strong>Total: $${result.total.toFixed(2)}</strong></p>
    
    <p>Original Price (no discounts): $${result.originalPrice.toFixed(2)}</p>
    <p>Total Discount: $${result.totalDiscount.toFixed(2)}</p>
    <p>Purchase Price Total: $${purchasePriceTotal.toFixed(2)}</p>
    <p>Rental as % of Purchase Price: ${rentalPercentOfPurchase.toFixed(2)}%</p>
  
  `;

  chartRenderer.plotQuantityChart();
  chartRenderer.plotDayChart();
  renderTable();
}


function refreshCharts() {
  if (chartRenderer) {
    chartRenderer.plotQuantityChart();
    chartRenderer.plotDayChart();
    renderTable();
  }
}


function attachChartInputListeners() {
  const chartInputs = [
    "quantity", "baseRate", "purchasePrice", "days", "sku",
    "qtyChartStep", "qtyChartMetric", "dayChartStep", "dayChartMetric",
    "tableMetric", "tableQtyStep", "tableDayStep"
  ];
  chartInputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("input", refreshCharts);
      if (el.tagName === "SELECT") {
        el.addEventListener("change", refreshCharts);
      }
    }
  });
}

function renderTable() {
  const qtyMax = parseInt(document.getElementById("quantity").value, 10) || 1;
  const qtyStep = parseInt(document.getElementById("tableQtyStep").value, 10) || 10;
  const dayMax = parseInt(document.getElementById("days").value, 10) || 1;
  const dayStep = parseInt(document.getElementById("tableDayStep").value, 10) || 1;
  const baseRate = parseFloat(document.getElementById("baseRate").value) || 0;
  const purchasePrice = parseFloat(document.getElementById("purchasePrice").value) || 0;
  const sku = document.getElementById("sku").value.trim();
  const metric = document.getElementById("tableMetric").value;
  const engine = new PricingEngine(pricingData);

  let html = '<table border="1" cellpadding="4" cellspacing="0"><thead><tr><th>Qty \ Days</th>';
  for (let day = 1; day <= dayMax; day += dayStep) {
    html += `<th>${day}</th>`;
  }
  html += '</tr></thead><tbody>';
  for (let qty = 1; qty <= qtyMax; qty += qtyStep) {
    html += `<tr><th>${qty}</th>`;
    for (let day = 1; day <= dayMax; day += dayStep) {
      const result = engine.calculateRental(qty, day, sku, baseRate);
      let value;
      if (metric === "percentOfPurchase") {
        const totalPurchase = qty * purchasePrice;
        value = totalPurchase > 0 ? (result.discountedPrice / totalPurchase) * 100 : 0;
        value = ChartRenderer.roundToOneDecimal(value) + "%";
      } else if (metric === "discountPct") {
        value = ChartRenderer.roundToOneDecimal(result[metric]) + "%";
      } else {
        value = "$" + ChartRenderer.roundToOneDecimal(result[metric]);
      }
      html += `<td>${value}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById("tableOutput").innerHTML = html;
}
</script>

</body>
</html>
